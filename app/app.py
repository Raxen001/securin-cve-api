from flask import Flask, request
from flask import render_template
#import requests
#import json

import pymongo
from pymongo import MongoClient
client = MongoClient('localhost', 27017)
database = client['cve']
collection = database['cve']
total = collection.count_documents({})


app = Flask(__name__)

@app.route('/')
@app.route('/cve/lists/')
def index():
    args = request.args
    year = args.get('year', default="", type=str)
    lastmodified = args.get('lastmodified', default=-1, type=int)
    lt = args.get('lt', default=10.0, type=float)
    gt = args.get('gt', default=0.0, type=float)
    id = args.get('id', default="", type=str)

    datas = collection.find()#.limit(10)
    payload = {
            "published": {
                    "$regex": year
                },
            "$or": [
                {"metrics.cvssMetricV2.cvssData.baseScore": {"$gte": gt, "$lte": lt}},
                {"metrics.cvssMetricV3.cvssData.baseScore": {"$gte": gt, "$lte": lt}}
                ]
            }
    datas = collection.find(payload)

    if lastmodified != -1:
        datas = collection.find(payload).sort("lastModified", -1).limit(lastmodified)
        datas = list(datas)
    else:
        datas = collection.find(payload)

    return render_template("table.html", datas=datas, total=total )

@app.route('/cve/lists/id/<cve_id>')
def cve_id(cve_id):
    data = collection.find_one(cve_id)
    return render_template('single.html', datas=data)

if __name__ == "__main__":
    #get_sample_data()
    app.run(debug=True)
