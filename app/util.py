import pymongo
from pymongo import MongoClient

import requests
import json

from pprint import pprint

def get_data(start_index=0, per_page=2000):
    URL = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    payload = {
            "startIndex": start_index,
            "resultsPerPage": per_page
            }

    request = requests.get(URL, params=payload)
    data = request.json()
    
    return data
    # with open("sample.json", 'w') as f:
    #     json.dump(data, f)


client = MongoClient('localhost', 27017)
database = client['cve']
collection = database['cve']

def write_db(datas):
    for data in datas:
        data = data['cve']
        data['_id'] = data['id']
        collection.insert_one(data)

    

def main():
    start_index = 0 
    per_page = 2000

    while True:

        data = get_data(start_index, per_page)
        if data['resultsPerPage'] == 0:
            break
        
        #pprint(data['vulnerabilities'][0]['cve']['id'])
        print(start_index, len(data['vulnerabilities']))
        write_db(data['vulnerabilities'])


        start_index += per_page




if __name__ == "__main__":

    main()
