import pymongo
from pymongo import MongoClient
import requests
import json
import time
from pprint import pprint

def get_data(start_index=0, per_page=2000):
    URL = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    payload = {
            "startIndex": start_index,
            "resultsPerPage": per_page
            }

    request = requests.get(URL, params=payload)
    status_code = request.status_code
    if status_code == 200:
        data = request.json()
    else:
        print(request.text)
        data = {}
    
    return (status_code, data)


client = MongoClient('localhost', 27017)
database = client['cve']
collection = database['cve']

def write_db(datas):
    for data in datas:
        data = data['cve']
        data['_id'] = data['id']
        try:
            collection.insert_one(data)
        except pymongo.errors.DuplicateKeyError:
            continue

def clean_db():
    """
        delete vulnerabilities with status rejected
    """
    filter = {"vulnStatus": "Rejected"}
    result = collection.delete_many(filter)
    print("Number of documents deleted:", result.deleted_count)  

def update_db(datas):
    for data in datas:
        data = data['cve']
        data['_id'] = data['id']
        try:
            collection.replace_one({"_id": data['_id']}, data)
        except:
            break

def get_update(start_index=0, per_page=2000):
    URL = "https://services.nvd.nist.gov/rest/json/cvehistory/2.0"

    last_date = "1999"
    with open("config.json", 'r') as f:
        data = json.load(f)
        last_date = data['last_date']


    payload = {
            "startIndex": start_index,
            "resultsPerPage": per_page,
            "start date": last_date
            }

    request = requests.get(URL, params=payload)
    status_code = request.status_code
    if status_code == 200:
        data = request.json()
    else:
        print(request.text)
        data = {}
    
    return (status_code, data)

def handle_update():
    start_index = 0
    per_page = 2000

    while True:

        status_code, data = get_update(start_index, per_page)
        if status_code == 200:
            start_index += per_page
        else:
            time.sleep(5)
            continue

        if data['resultsPerPage'] == 0:
            break
        
        write_db(data['vulnerabilities'])


def main():
    start_index = 0
    per_page = 2000

    while True:
        #debug

        status_code, data = get_data(start_index, per_page)
        #print(status_code, ":", start_index, "|", (start_index / 248825) * 100)
        if status_code == 200:
            start_index += per_page
        else:
            time.sleep(5)
            continue

        if data['resultsPerPage'] == 0:
            break
        
        #pprint(data['vulnerabilities'][0]['cve']['id'])
        write_db(data['vulnerabilities'])






if __name__ == "__main__":

    main()
    while True:
        clean_db()
        time.sleep(30 * 60) # sleeps for 30 minutes and updated the cves list
        handle_update()
